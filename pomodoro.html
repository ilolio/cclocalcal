<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ポモドーロタイマー</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .timer-display {
            padding: 60px 30px;
            text-align: center;
            background: #f8f9fa;
        }

        .mode-label {
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .mode-label.work {
            color: #667eea;
        }

        .mode-label.break {
            color: #43e97b;
        }

        .mode-label.long-break {
            color: #4facfe;
        }

        .timer {
            font-size: 5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
            font-variant-numeric: tabular-nums;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .controls button {
            padding: 15px 30px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-start {
            background: #667eea;
            color: white;
        }

        .btn-start:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-pause {
            background: #fa709a;
            color: white;
        }

        .btn-pause:hover {
            background: #f5576c;
            transform: translateY(-2px);
        }

        .btn-reset {
            background: #e9ecef;
            color: #495057;
        }

        .btn-reset:hover {
            background: #dee2e6;
            transform: translateY(-2px);
        }

        .stats {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            border-top: 2px solid #e9ecef;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .settings {
            padding: 30px;
            border-top: 2px solid #e9ecef;
            background: #f8f9fa;
        }

        .settings h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-item label {
            font-size: 0.9em;
            color: #495057;
            font-weight: 500;
        }

        .setting-item input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .setting-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .setting-checkbox {
            margin-top: 10px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .setting-checkbox label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #495057;
            font-weight: 500;
            cursor: pointer;
        }

        .setting-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .start-mode {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .start-mode label {
            display: block;
            font-size: 0.9em;
            color: #495057;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .start-mode-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
        }

        .start-mode-section .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .start-mode-section label {
            font-size: 0.9em;
            color: #495057;
            font-weight: 500;
            margin: 0;
        }

        .settings-toggle-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .settings-toggle-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .mode-btn:hover {
            background: #f0f2ff;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .save-settings {
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
        }

        .save-settings:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 600px) {
            .timer {
                font-size: 3.5em;
            }

            .controls button {
                padding: 12px 20px;
                font-size: 0.9em;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ポモドーロタイマー</h1>
            <p>集中と休憩のバランスで生産性を向上</p>
        </div>

        <div class="timer-display">
            <div class="mode-label work" id="modeLabel">作業時間</div>
            <div class="timer" id="timer">25:00</div>
            <div class="controls">
                <button class="btn-start" id="startBtn" onclick="startTimer()">開始</button>
                <button class="btn-pause" id="pauseBtn" onclick="pauseTimer()" style="display: none;">一時停止</button>
                <button class="btn-reset" onclick="resetTimer()">リセット</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="cycleCount">0</div>
                <div class="stat-label">完了サイクル</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalWork">0</div>
                <div class="stat-label">作業セッション</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalBreaks">0</div>
                <div class="stat-label">休憩回数</div>
            </div>
        </div>

        <div class="start-mode-section">
            <div class="section-header">
                <label>開始モード</label>
                <button class="settings-toggle-btn" onclick="toggleSettings()">⚙️ 設定</button>
            </div>
            <div class="mode-buttons">
                <button class="mode-btn active" id="startWithWork" onclick="setStartMode('work')">作業から開始</button>
                <button class="mode-btn" id="startWithBreak" onclick="setStartMode('break')">休憩から開始</button>
            </div>
        </div>

        <div class="settings" id="settingsSection" style="display: none;">
            <h3>設定</h3>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="workDuration">作業時間（分）</label>
                    <input type="number" id="workDuration" value="25" min="1" max="60">
                </div>
                <div class="setting-item">
                    <label for="shortBreakDuration">短い休憩（分）</label>
                    <input type="number" id="shortBreakDuration" value="5" min="1" max="30">
                </div>
                <div class="setting-item">
                    <label for="longBreakDuration">長い休憩（分）</label>
                    <input type="number" id="longBreakDuration" value="15" min="1" max="60">
                </div>
                <div class="setting-item">
                    <label for="cyclesBeforeLongBreak">長い休憩までのサイクル</label>
                    <input type="number" id="cyclesBeforeLongBreak" value="4" min="1" max="10">
                </div>
                <div class="setting-item">
                    <label for="initialBreakDuration">最初の休憩時間（分）</label>
                    <input type="number" id="initialBreakDuration" value="10" min="1" max="60">
                </div>
            </div>

            <div class="setting-checkbox">
                <label>
                    <input type="checkbox" id="soundEnabled" checked>
                    通知音を鳴らす
                </label>
            </div>

            <button class="save-settings" onclick="saveSettings()">設定を保存</button>
        </div>
    </div>

    <div class="notification" id="notification">
        <p id="notificationText"></p>
    </div>

    <script>
        // タイマーの状態
        let timerInterval = null;
        let remainingSeconds = 0;
        let isRunning = false;
        let currentMode = 'work'; // 'work', 'short-break', 'long-break', 'initial-break'
        let cycleCount = 0;
        let workSessionCount = 0;
        let breakCount = 0;
        let startMode = 'work'; // 'work' or 'break'
        let isInitialBreak = false; // 最初の休憩かどうか

        // 設定
        let settings = {
            workDuration: 25,
            shortBreakDuration: 5,
            longBreakDuration: 15,
            cyclesBeforeLongBreak: 4,
            initialBreakDuration: 10,
            soundEnabled: true
        };

        // 初期化
        function init() {
            loadSettings();
            loadStats();
            updateSettingsUI();

            // 開始モードに応じて初期状態を設定
            if (startMode === 'break') {
                currentMode = 'initial-break';
                isInitialBreak = true;
            } else {
                currentMode = 'work';
                isInitialBreak = false;
            }

            resetTimer();
        }

        // 設定の読み込み
        function loadSettings() {
            const saved = localStorage.getItem('pomodoroSettings');
            if (saved) {
                const data = JSON.parse(saved);
                settings = data.settings || settings;
                startMode = data.startMode || 'work';

                // UIを更新
                updateStartModeUI();
            }
        }

        // 設定の保存
        function saveSettings() {
            settings.workDuration = parseInt(document.getElementById('workDuration').value);
            settings.shortBreakDuration = parseInt(document.getElementById('shortBreakDuration').value);
            settings.longBreakDuration = parseInt(document.getElementById('longBreakDuration').value);
            settings.cyclesBeforeLongBreak = parseInt(document.getElementById('cyclesBeforeLongBreak').value);
            settings.initialBreakDuration = parseInt(document.getElementById('initialBreakDuration').value);
            settings.soundEnabled = document.getElementById('soundEnabled').checked;

            const data = {
                settings: settings,
                startMode: startMode
            };
            localStorage.setItem('pomodoroSettings', JSON.stringify(data));

            showNotification('設定を保存しました');

            // タイマーが動いていない場合は現在のモードの時間をリセット
            if (!isRunning) {
                resetTimer();
            }
        }

        // 統計の読み込み
        function loadStats() {
            const saved = localStorage.getItem('pomodoroStats');
            if (saved) {
                const stats = JSON.parse(saved);
                cycleCount = stats.cycleCount || 0;
                workSessionCount = stats.workSessionCount || 0;
                breakCount = stats.breakCount || 0;
                updateStatsUI();
            }
        }

        // 統計の保存
        function saveStats() {
            const stats = {
                cycleCount: cycleCount,
                workSessionCount: workSessionCount,
                breakCount: breakCount
            };
            localStorage.setItem('pomodoroStats', JSON.stringify(stats));
        }

        // 設定UIの更新
        function updateSettingsUI() {
            document.getElementById('workDuration').value = settings.workDuration;
            document.getElementById('shortBreakDuration').value = settings.shortBreakDuration;
            document.getElementById('longBreakDuration').value = settings.longBreakDuration;
            document.getElementById('cyclesBeforeLongBreak').value = settings.cyclesBeforeLongBreak;
            document.getElementById('initialBreakDuration').value = settings.initialBreakDuration;
            document.getElementById('soundEnabled').checked = settings.soundEnabled;
        }

        // 統計UIの更新
        function updateStatsUI() {
            document.getElementById('cycleCount').textContent = cycleCount;
            document.getElementById('totalWork').textContent = workSessionCount;
            document.getElementById('totalBreaks').textContent = breakCount;
        }

        // 開始モードの設定
        function setStartMode(mode) {
            startMode = mode;

            // 開始モードに応じて現在のモードを設定
            if (startMode === 'break') {
                currentMode = 'initial-break';
                isInitialBreak = true;
            } else {
                currentMode = 'work';
                isInitialBreak = false;
            }

            updateStartModeUI();

            // タイマーが動いていない場合のみリセット
            if (!isRunning) {
                resetTimer();
            }
        }

        // 開始モードUIの更新
        function updateStartModeUI() {
            const workBtn = document.getElementById('startWithWork');
            const breakBtn = document.getElementById('startWithBreak');

            if (startMode === 'work') {
                workBtn.classList.add('active');
                breakBtn.classList.remove('active');
            } else {
                workBtn.classList.remove('active');
                breakBtn.classList.add('active');
            }
        }

        // タイマーの開始
        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'inline-block';

                timerInterval = setInterval(() => {
                    remainingSeconds--;
                    updateTimerDisplay();

                    if (remainingSeconds <= 0) {
                        completeSession();
                    }
                }, 1000);
            }
        }

        // タイマーの一時停止
        function pauseTimer() {
            if (isRunning) {
                isRunning = false;
                clearInterval(timerInterval);
                document.getElementById('startBtn').style.display = 'inline-block';
                document.getElementById('pauseBtn').style.display = 'none';
            }
        }

        // タイマーのリセット
        function resetTimer() {
            pauseTimer();

            // モードに応じた時間を設定
            if (currentMode === 'work') {
                remainingSeconds = settings.workDuration * 60;
            } else if (currentMode === 'initial-break') {
                remainingSeconds = settings.initialBreakDuration * 60;
            } else if (currentMode === 'short-break') {
                remainingSeconds = settings.shortBreakDuration * 60;
            } else {
                remainingSeconds = settings.longBreakDuration * 60;
            }

            updateTimerDisplay();
            updateModeLabel();
        }

        // セッションの完了
        function completeSession() {
            pauseTimer();

            // 通知音が有効な場合のみ再生
            if (settings.soundEnabled) {
                playNotificationSound();
            }

            // 統計の更新
            if (currentMode === 'work') {
                workSessionCount++;
                cycleCount++;
                showNotification('作業時間が完了しました！休憩を取りましょう。');

                // 次のモードを決定
                if (cycleCount % settings.cyclesBeforeLongBreak === 0) {
                    currentMode = 'long-break';
                } else {
                    currentMode = 'short-break';
                }
            } else if (currentMode === 'initial-break') {
                // 最初の休憩が完了した場合
                breakCount++;
                isInitialBreak = false;
                showNotification('最初の休憩が完了しました！作業を始めましょう。');
                currentMode = 'work';
            } else {
                // 通常の休憩が完了した場合
                breakCount++;
                showNotification('休憩が完了しました！次の作業を始めましょう。');
                currentMode = 'work';
            }

            saveStats();
            updateStatsUI();
            resetTimer();
        }

        // タイマー表示の更新
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            document.getElementById('timer').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // ブラウザのタイトルも更新
            document.title = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} - ポモドーロタイマー`;
        }

        // モードラベルの更新
        function updateModeLabel() {
            const label = document.getElementById('modeLabel');

            if (currentMode === 'work') {
                label.textContent = '作業時間';
                label.className = 'mode-label work';
            } else if (currentMode === 'initial-break') {
                label.textContent = '最初の休憩';
                label.className = 'mode-label break';
            } else if (currentMode === 'short-break') {
                label.textContent = '短い休憩';
                label.className = 'mode-label break';
            } else {
                label.textContent = '長い休憩';
                label.className = 'mode-label long-break';
            }
        }

        // 通知の表示
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            text.textContent = message;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 設定の表示/非表示を切り替え
        function toggleSettings() {
            const settingsSection = document.getElementById('settingsSection');
            if (settingsSection.style.display === 'none') {
                settingsSection.style.display = 'block';
            } else {
                settingsSection.style.display = 'none';
            }
        }

        // 通知音の再生
        function playNotificationSound() {
            // Web Audio APIを使用してシンプルなビープ音を生成
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // ページが非表示になる時にタイマーを一時停止
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isRunning) {
                // ブラウザのタブが非表示になっても動作を継続
                // 必要に応じて一時停止する場合は pauseTimer() を呼ぶ
            }
        });

        // 初期化
        window.addEventListener('load', init);
    </script>
</body>
</html>
